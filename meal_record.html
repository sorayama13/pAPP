<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™ºé…µé£Ÿå“ãƒ»é£Ÿç‰©ç¹Šç¶­è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    
    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;ç™ºé…µé£Ÿå“è¨˜éŒ²ã‚¢ãƒ—ãƒª&quot;,&quot;short_name&quot;:&quot;ç™ºé…µè¨˜éŒ²&quot;,&quot;description&quot;:&quot;ç™ºé…µé£Ÿå“ãƒ»é£Ÿç‰©ç¹Šç¶­ãƒ»é£Ÿå“å¤šæ§˜æ€§ã‚’è¨˜éŒ²ã™ã‚‹ã‚¢ãƒ—ãƒª&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#4CAF50&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM0Q0FGNTAiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LTggMy41OS04IDgtOCA0LjQxIDAgOCAzLjU5IDggOC04IDMuNTktOCA4eiIvPgo8L3N2Zz4KPC9zdmc+&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}],"}"}>
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ç™ºé…µè¨˜éŒ²">
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .date-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            min-width: 44px;
            min-height: 44px;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .reset-btn {
            opacity: 0.7;
            font-size: 14px;
        }
        
        .reset-btn:hover {
            opacity: 1;
        }
        
        .current-date {
            font-size: 18px;
            font-weight: bold;
        }
        
        .progress-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .summary-item {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .section-card {
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 44px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .section-toggle {
            font-size: 20px;
            color: #666;
            transition: transform 0.3s;
        }
        
        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .section-content {
            padding: 20px;
            display: block;
        }
        
        .section-content.collapsed {
            display: none;
        }
        
        /* ç™ºé…µé£Ÿå“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .fermented-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .fermented-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 44px;
        }
        
        .fermented-option:hover {
            background: #e9ecef;
        }
        
        .fermented-option.selected {
            background: #d4edda;
            border: 2px solid #4CAF50;
        }
        
        .fermented-checkbox {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }
        
        .fermented-label {
            font-size: 14px;
            font-weight: 500;
        }
        
        .fermented-summary {
            text-align: center;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        /* é£Ÿç‰©ç¹Šç¶­ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .fiber-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .fiber-category {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 44px;
        }
        
        .fiber-category:hover {
            background: #e9ecef;
            border-color: #4CAF50;
        }
        
        .fiber-category:active {
            transform: scale(0.95);
        }
        
        .fiber-category-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .fiber-category-value {
            font-size: 14px;
            color: #666;
        }
        
        .fiber-summary {
            text-align: center;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .fiber-progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .fiber-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s;
        }
        
        /* é£Ÿç‰©ç¹Šç¶­è©³ç´°è¡¨ç¤º */
        .fiber-details {
            margin: 15px 0;
        }
        
        .fiber-record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .fiber-record-info {
            display: flex;
            flex-direction: column;
        }
        
        .fiber-record-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        .fiber-record-value {
            font-size: 12px;
            color: #666;
        }
        
        .remove-fiber-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            min-width: 44px;
            min-height: 44px;
        }
        
        .remove-fiber-btn:hover {
            background: #c82333;
        }
        
        /* ä»Šé€±ã®æ¤ç‰©ä¸€è¦§è¡¨ç¤º */
        .weekly-plants-list {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .weekly-plants-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .weekly-plants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }
        
        .weekly-plant-tag {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 12px;
            text-align: center;
            border: 1px solid #c8e6c9;
        }
        
        .weekly-plant-tag.duplicate {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
        
        /* é£Ÿå“å¤šæ§˜æ€§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .plant-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .plant-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            min-height: 44px;
        }
        
        .plant-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .add-plant-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            min-width: 44px;
            min-height: 44px;
        }
        
        .add-plant-btn:hover {
            background: #45a049;
        }
        
        .plants-list {
            margin-top: 15px;
        }
        
        .plant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .plant-name {
            font-size: 14px;
        }
        
        .remove-plant-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .diversity-progress {
            margin-top: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s;
        }
        
        /* ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
            min-height: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .nav-item.active {
            color: #4CAF50;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .nav-label {
            font-size: 12px;
        }

        
        
        /* ãƒ¬ãƒãƒ¼ãƒˆç”»é¢ */
        .report-section {
            margin-bottom: 30px;
        }
        
        .report-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
        @media (max-width: 480px) {
            .fermented-options,
            .fiber-categories {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            animation: fadeIn 0.3s ease-in;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <div class="date-nav">
                <button class="nav-btn" onclick="changeDate(-1)">â€¹</button>
                <div class="current-date" id="currentDate"></div>
                <button class="nav-btn" onclick="changeDate(1)">â€º</button>
                <button class="nav-btn reset-btn" onclick="resetAllData()" title="ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ">ğŸ”„</button>
            </div>
            <div class="progress-summary">
                <div class="summary-item">
                    <div class="summary-value" id="fermentedCount">0</div>
                    <div class="summary-label">ç™ºé…µé£Ÿå“</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="fiberCount">0g</div>
                    <div class="summary-label">é£Ÿç‰©ç¹Šç¶­</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="plantCount">0</div>
                    <div class="summary-label">æ¤ç‰©ç¨®é¡</div>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-content" id="mainContent">
            <!-- ç™ºé…µé£Ÿå“è¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-card">
                <div class="section-header" onclick="toggleSection('fermented')">
                    <div class="section-title">ç™ºé…µé£Ÿå“è¨˜éŒ²</div>
                    <div class="section-toggle" id="fermentedToggle">â–¼</div>
                </div>
                <div class="section-content" id="fermentedContent">
                    <div class="fermented-options" id="fermentedOptions">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                    <div class="fermented-summary" id="fermentedSummary">
                        ä»Šæ—¥ã¯ <span id="fermentedSelected">0</span> ç¨®é¡ã®ç™ºé…µé£Ÿå“ã‚’é£Ÿã¹ã¾ã—ãŸ
                        <br>
                        <small>ç›®æ¨™: 1æ—¥2ç¨®é¡ä»¥ä¸Š</small>
                    </div>
                </div>
            </div>

            <!-- é£Ÿç‰©ç¹Šç¶­è¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-card">
                <div class="section-header" onclick="toggleSection('fiber')">
                    <div class="section-title">é£Ÿç‰©ç¹Šç¶­è¨˜éŒ²</div>
                    <div class="section-toggle" id="fiberToggle">â–¼</div>
                </div>
                <div class="section-content" id="fiberContent">
                    <div class="fiber-categories" id="fiberCategories">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                    <div class="fiber-details" id="fiberDetails">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹è¨˜éŒ²è©³ç´° -->
                    </div>
                    <div class="fiber-summary" id="fiberSummary">
                        <div>ä»Šæ—¥ã®é£Ÿç‰©ç¹Šç¶­: <span id="fiberTotal">0</span>g / <span id="fiberGoal">18</span>g</div>
                        <div class="fiber-progress">
                            <div class="fiber-progress-bar" id="fiberProgressBar" style="width: 0%"></div>
                        </div>
                        <small>ç›®æ¨™é”æˆã¾ã§ <span id="fiberRemaining">18</span>g</small>
                    </div>
                </div>
            </div>

            <!-- é£Ÿå“å¤šæ§˜æ€§è¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section-card">
                <div class="section-header" onclick="toggleSection('plants')">
                    <div class="section-title">é£Ÿå“å¤šæ§˜æ€§è¨˜éŒ²</div>
                    <div class="section-toggle" id="plantsToggle">â–¼</div>
                </div>
                <div class="section-content" id="plantsContent">
                    <div class="plant-input-container">
                        <input type="text" class="plant-input" id="plantInput" placeholder="æ¤ç‰©åã‚’å…¥åŠ›ï¼ˆä¾‹: ãƒˆãƒãƒˆï¼‰">
                        <button class="add-plant-btn" onclick="addPlant()">è¿½åŠ </button>
                    </div>
                    <div class="plants-list" id="plantsList">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                    <div class="weekly-plants-list" id="weeklyPlantsList">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ä»Šé€±ã®æ¤ç‰©ä¸€è¦§ -->
                    </div>
                    <div class="diversity-progress">
                        <div>ä»Šé€±ã®æ¤ç‰©ç¨®é¡: <span id="weeklyPlantCount">0</span> / 30ç¨®é¡</div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="weeklyPlantProgress" style="width: 0%"></div>
                        </div>
                        <small>ç›®æ¨™: é€±30ç¨®é¡</small>
                    </div>
                </div>
            </div>
        </main>

        <!-- ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showPage('main')">
                <div class="nav-icon">ğŸ“</div>
                <div class="nav-label">è¨˜éŒ²</div>
            </div>
            <div class="nav-item" onclick="showPage('weekly')">
                <div class="nav-icon">ğŸ“Š</div>
                <div class="nav-label">é€±æ¬¡</div>
            </div>
            <div class="nav-item" onclick="showPage('monthly')">
                <div class="nav-icon">ğŸ“ˆ</div>
                <div class="nav-label">æœˆæ¬¡</div>
            </div>
        </nav>
    </div>


    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentDate = new Date();
        let appData = {};
        let settings = {
            gender: 'female',
            fiberGoal: 18,
            notifications: true
        };
        let currentPage = 'main';

        // ç™ºé…µé£Ÿå“ã®é¸æŠè‚¢
        const fermentedOptions = [
            'ç´è±†', 'ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ', 'å‘³å™Œï¼ˆå‘³å™Œæ±å«ã‚€ï¼‰', 
            'ã‚­ãƒ ãƒãƒ»æ¼¬ç‰©', 'ãƒãƒ¼ã‚º', 'ç”˜é…’ãƒ»å¡©éº¹'
        ];

        // é£Ÿç‰©ç¹Šç¶­ã‚«ãƒ†ã‚´ãƒª
        const fiberCategories = [
            { name: 'ç”Ÿé‡èœã‚µãƒ©ãƒ€', value: 3 },
            { name: 'æ¸©é‡èœãƒ»ç…®ç‰©', value: 5 },
            { name: 'é‡èœã‚¹ãƒ¼ãƒ—ãƒ»å‘³å™Œæ±', value: 2 },
            { name: 'æµ·è—»é¡', value: 1 },
            { name: 'ç„ç±³ãƒ»é›‘ç©€ç±³', value: 3 },
            { name: 'ç´è±†', value: 3 },
            { name: 'ãã®ã“é¡', value: 2 },
            { name: 'æœç‰©', value: 2 }
        ];

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadSettings();
            initializeApp();
            setupEventListeners();
        });

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadData() {
            try {
                const savedData = localStorage.getItem('pmcAppData');
                if (savedData) {
                    appData = JSON.parse(savedData);
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // è¨­å®šèª­ã¿è¾¼ã¿
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('pmcAppSettings');
                if (savedSettings) {
                    settings = { ...settings, ...JSON.parse(savedSettings) };
                }
            } catch (error) {
                console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveData() {
            try {
                localStorage.setItem('pmcAppData', JSON.stringify(appData));
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // è¨­å®šä¿å­˜
        function saveSettings() {
            try {
                localStorage.setItem('pmcAppSettings', JSON.stringify(settings));
            } catch (error) {
                console.error('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showMessage('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        function initializeApp() {
            updateDateDisplay();
            initializeFermentedOptions();
            initializeFiberCategories();
            updateSummary();
            loadCurrentDayData();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // æ¤ç‰©å…¥åŠ›ã§Enterã‚­ãƒ¼å¯¾å¿œ
            document.getElementById('plantInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addPlant();
                }
            });

            // PWAå¯¾å¿œ
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,console.log("PWA Service Worker")');
            }
        }

        // æ—¥ä»˜è¡¨ç¤ºæ›´æ–°
        function updateDateDisplay() {
            const dateStr = formatDate(currentDate);
            document.getElementById('currentDate').textContent = dateStr;
        }

        // æ—¥ä»˜å¤‰æ›´
        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateDisplay();
            loadCurrentDayData();
            updateSummary();
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(date) {
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
        }

        // æ—¥ä»˜ã‚­ãƒ¼å–å¾—
        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        // ç¾åœ¨ã®æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadCurrentDayData() {
            const dateKey = getDateKey(currentDate);
            const dayData = appData[dateKey] || {
                fermented: [],
                fiber: 0,
                fiberDetail: {},
                plants: []
            };
            
            updateFermentedDisplay(dayData.fermented);
            updateFiberDisplay(dayData.fiber, dayData.fiberDetail);
            updatePlantsDisplay(dayData.plants);
        }

        // ç™ºé…µé£Ÿå“ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        function initializeFermentedOptions() {
            const container = document.getElementById('fermentedOptions');
            container.innerHTML = '';
            
            fermentedOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'fermented-option';
                div.onclick = () => toggleFermented(option);
                
                div.innerHTML = `
                    <input type="checkbox" class="fermented-checkbox" id="fermented_${option}">
                    <label class="fermented-label" for="fermented_${option}">${option}</label>
                `;
                container.appendChild(div);
            });
        }

        // ç™ºé…µé£Ÿå“é¸æŠåˆ‡ã‚Šæ›¿ãˆ
        function toggleFermented(option) {
            const dateKey = getDateKey(currentDate);
            if (!appData[dateKey]) {
                appData[dateKey] = { fermented: [], fiber: 0, fiberDetail: {}, plants: [] };
            }
            
            const fermented = appData[dateKey].fermented;
            const index = fermented.indexOf(option);
            
            if (index > -1) {
                fermented.splice(index, 1);
            } else {
                fermented.push(option);
            }
            
            updateFermentedDisplay(fermented);
            saveData();
            updateSummary();
        }

        // ç™ºé…µé£Ÿå“è¡¨ç¤ºæ›´æ–°
        function updateFermentedDisplay(selected) {
            fermentedOptions.forEach(option => {
                const checkbox = document.getElementById(`fermented_${option}`);
                const optionDiv = checkbox.closest('.fermented-option');
                
                if (selected.includes(option)) {
                    checkbox.checked = true;
                    optionDiv.classList.add('selected');
                } else {
                    checkbox.checked = false;
                    optionDiv.classList.remove('selected');
                }
            });
            
            document.getElementById('fermentedSelected').textContent = selected.length;
        }

        // é£Ÿç‰©ç¹Šç¶­ã‚«ãƒ†ã‚´ãƒªåˆæœŸåŒ–
        function initializeFiberCategories() {
            const container = document.getElementById('fiberCategories');
            container.innerHTML = '';
            
            fiberCategories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'fiber-category';
                div.onclick = () => addFiber(category.name, category.value);
                
                div.innerHTML = `
                    <div class="fiber-category-name">${category.name}</div>
                    <div class="fiber-category-value">+${category.value}g</div>
                `;
                container.appendChild(div);
            });
        }

        // é£Ÿç‰©ç¹Šç¶­è¿½åŠ 
        function addFiber(categoryName, value) {
            const dateKey = getDateKey(currentDate);
            if (!appData[dateKey]) {
                appData[dateKey] = { fermented: [], fiber: 0, fiberDetail: {}, plants: [] };
            }
            
            const dayData = appData[dateKey];
            dayData.fiber += value;
            dayData.fiberDetail[categoryName] = (dayData.fiberDetail[categoryName] || 0) + 1;
            
            updateFiberDisplay(dayData.fiber, dayData.fiberDetail);
            saveData();
            updateSummary();
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showMessage(`${categoryName}ã‚’è¿½åŠ ã—ã¾ã—ãŸ (+${value}g)`, 'success');
        }

        // é£Ÿç‰©ç¹Šç¶­è¡¨ç¤ºæ›´æ–°
        function updateFiberDisplay(total, detail) {
            document.getElementById('fiberTotal').textContent = total;
            document.getElementById('fiberGoal').textContent = settings.fiberGoal;
            
            const remaining = Math.max(0, settings.fiberGoal - total);
            document.getElementById('fiberRemaining').textContent = remaining;
            
            const progress = Math.min(100, (total / settings.fiberGoal) * 100);
            document.getElementById('fiberProgressBar').style.width = progress + '%';
            
            // è©³ç´°è¨˜éŒ²ã®è¡¨ç¤ºæ›´æ–°
            updateFiberDetails(detail);
        }
        
        // é£Ÿç‰©ç¹Šç¶­è©³ç´°è¡¨ç¤ºæ›´æ–°
        function updateFiberDetails(detail) {
            const container = document.getElementById('fiberDetails');
            container.innerHTML = '';
            
            // è¨˜éŒ²ãŒãªã„å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
            if (Object.keys(detail).length === 0) {
                return;
            }
            
            // å„ã‚«ãƒ†ã‚´ãƒªã®è¨˜éŒ²ã‚’è¡¨ç¤º
            Object.entries(detail).forEach(([categoryName, count]) => {
                if (count > 0) {
                    const category = fiberCategories.find(cat => cat.name === categoryName);
                    if (category) {
                        const totalValue = category.value * count;
                        const div = document.createElement('div');
                        div.className = 'fiber-record-item';
                        div.innerHTML = `
                            <div class="fiber-record-info">
                                <div class="fiber-record-name">${categoryName}</div>
                                <div class="fiber-record-value">${count}å› Ã— ${category.value}g = ${totalValue}g</div>
                            </div>
                            <button class="remove-fiber-btn" onclick="removeFiberRecord('${categoryName}')">å‰Šé™¤</button>
                        `;
                        container.appendChild(div);
                    }
                }
            });
        }

        // æ¤ç‰©è¿½åŠ 
        function addPlant() {
            const input = document.getElementById('plantInput');
            const plantName = input.value.trim();
            
            if (!plantName) {
                showMessage('æ¤ç‰©åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const dateKey = getDateKey(currentDate);
            if (!appData[dateKey]) {
                appData[dateKey] = { fermented: [], fiber: 0, fiberDetail: {}, plants: [] };
            }
            
            const plants = appData[dateKey].plants;
            if (plants.includes(plantName)) {
                showMessage('ã“ã®æ¤ç‰©ã¯ä»Šæ—¥æ—¢ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'error');
                return;
            }
            
            // ä»Šé€±æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const weekPlants = getWeeklyPlants();
            const isWeeklyDuplicate = weekPlants.includes(plantName);
            
            plants.push(plantName);
            input.value = '';
            
            updatePlantsDisplay(plants);
            saveData();
            updateSummary();
            
            if (isWeeklyDuplicate) {
                showMessage(`${plantName}ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆä»Šé€±2å›ç›®ã®ç™»éŒ²ã§ã™ï¼‰`, 'success');
            } else {
                showMessage(`${plantName}ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆä»Šé€±åˆå›ç™»éŒ²ï¼‰`, 'success');
            }
        }

        // é£Ÿç‰©ç¹Šç¶­è¨˜éŒ²å‰Šé™¤
        function removeFiberRecord(categoryName) {
            const dateKey = getDateKey(currentDate);
            if (appData[dateKey] && appData[dateKey].fiberDetail[categoryName]) {
                const dayData = appData[dateKey];
                const category = fiberCategories.find(cat => cat.name === categoryName);
                
                if (category) {
                    // 1å›åˆ†ã®è¨˜éŒ²ã‚’å‰Šé™¤
                    dayData.fiberDetail[categoryName]--;
                    dayData.fiber -= category.value;
                    
                    // ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã«ãªã£ãŸã‚‰å‰Šé™¤
                    if (dayData.fiberDetail[categoryName] <= 0) {
                        delete dayData.fiberDetail[categoryName];
                    }
                    
                    // è¡¨ç¤ºæ›´æ–°
                    updateFiberDisplay(dayData.fiber, dayData.fiberDetail);
                    saveData();
                    updateSummary();
                    
                    showMessage(`${categoryName}ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ (-${category.value}g)`, 'success');
                }
            }
        }

        // æ¤ç‰©å‰Šé™¤
        function removePlant(plantName) {
            const dateKey = getDateKey(currentDate);
            if (appData[dateKey]) {
                const plants = appData[dateKey].plants;
                const index = plants.indexOf(plantName);
                if (index > -1) {
                    plants.splice(index, 1);
                    updatePlantsDisplay(plants);
                    saveData();
                    updateSummary();
                }
            }
        }

        // æ¤ç‰©è¡¨ç¤ºæ›´æ–°
        function updatePlantsDisplay(plants) {
            const container = document.getElementById('plantsList');
            container.innerHTML = '';
            
            plants.forEach(plant => {
                const div = document.createElement('div');
                div.className = 'plant-item';
                div.innerHTML = `
                    <span class="plant-name">${plant}</span>
                    <button class="remove-plant-btn" onclick="removePlant('${plant}')">å‰Šé™¤</button>
                `;
                container.appendChild(div);
            });
            
            // é€±æ¬¡é€²æ—æ›´æ–°
            updateWeeklyProgress();
        }

        // é€±æ¬¡é€²æ—æ›´æ–°
        function updateWeeklyProgress() {
            const weekPlants = getWeeklyPlants();
            const uniquePlants = [...new Set(weekPlants)];
            const count = uniquePlants.length;
            
            document.getElementById('weeklyPlantCount').textContent = count;
            
            const progress = Math.min(100, (count / 30) * 100);
            document.getElementById('weeklyPlantProgress').style.width = progress + '%';
            
            // ä»Šé€±ã®æ¤ç‰©ä¸€è¦§ã‚’æ›´æ–°
            updateWeeklyPlantsList(weekPlants, uniquePlants);
        }
        
        // ä»Šé€±ã®æ¤ç‰©ä¸€è¦§è¡¨ç¤ºæ›´æ–°
        function updateWeeklyPlantsList(weekPlants, uniquePlants) {
            const container = document.getElementById('weeklyPlantsList');
            container.innerHTML = '';
            
            if (uniquePlants.length === 0) {
                return;
            }
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'weekly-plants-title';
            titleDiv.textContent = 'ä»Šé€±ç™»éŒ²æ¸ˆã¿ã®æ¤ç‰©ç¨®é¡';
            container.appendChild(titleDiv);
            
            const gridDiv = document.createElement('div');
            gridDiv.className = 'weekly-plants-grid';
            
            // æ¤ç‰©ã®å‡ºç¾å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const plantCounts = {};
            weekPlants.forEach(plant => {
                plantCounts[plant] = (plantCounts[plant] || 0) + 1;
            });
            
            // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ¤ç‰©ã‚’ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚½ãƒ¼ãƒˆ
            uniquePlants.sort().forEach(plant => {
                const plantTag = document.createElement('div');
                plantTag.className = 'weekly-plant-tag';
                
                const count = plantCounts[plant];
                if (count > 1) {
                    plantTag.classList.add('duplicate');
                    plantTag.textContent = `${plant} (${count}å›)`;
                } else {
                    plantTag.textContent = plant;
                }
                
                gridDiv.appendChild(plantTag);
            });
            
            container.appendChild(gridDiv);
        }

        // é€±æ¬¡æ¤ç‰©ãƒ‡ãƒ¼ã‚¿å–å¾—
        function getWeeklyPlants() {
            const today = new Date(currentDate);
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            
            const weekPlants = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const dateKey = getDateKey(date);
                if (appData[dateKey] && appData[dateKey].plants) {
                    weekPlants.push(...appData[dateKey].plants);
                }
            }
            
            return weekPlants;
        }

        // ã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateSummary() {
            const dateKey = getDateKey(currentDate);
            const dayData = appData[dateKey] || { fermented: [], fiber: 0, plants: [] };
            
            document.getElementById('fermentedCount').textContent = dayData.fermented.length;
            document.getElementById('fiberCount').textContent = dayData.fiber + 'g';
            document.getElementById('plantCount').textContent = dayData.plants.length;
        }

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            const toggle = document.getElementById(sectionName + 'Toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
            }
        }

        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        function showPage(page) {
            currentPage = page;
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°
            const mainContent = document.getElementById('mainContent');
            
            switch(page) {
                case 'main':
                    mainContent.innerHTML = getMainContent();
                    initializeApp();
                    break;
                case 'weekly':
                    mainContent.innerHTML = getWeeklyReport();
                    loadWeeklyReport();
                    break;
                case 'monthly':
                    mainContent.innerHTML = getMonthlyReport();
                    loadMonthlyReport();
                    break;
            }
        }

        // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å–å¾—
        function getMainContent() {
            return `
                <!-- ç™ºé…µé£Ÿå“è¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('fermented')">
                        <div class="section-title">ç™ºé…µé£Ÿå“è¨˜éŒ²</div>
                        <div class="section-toggle" id="fermentedToggle">â–¼</div>
                    </div>
                    <div class="section-content" id="fermentedContent">
                        <div class="fermented-options" id="fermentedOptions">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                        <div class="fermented-summary" id="fermentedSummary">
                            ä»Šæ—¥ã¯ <span id="fermentedSelected">0</span> ç¨®é¡ã®ç™ºé…µé£Ÿå“ã‚’é£Ÿã¹ã¾ã—ãŸ
                            <br>
                            <small>ç›®æ¨™: 1æ—¥2ç¨®é¡ä»¥ä¸Š</small>
                        </div>
                    </div>
                </div>

                <!-- é£Ÿç‰©ç¹Šç¶­è¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('fiber')">
                        <div class="section-title">é£Ÿç‰©ç¹Šç¶­è¨˜éŒ²</div>
                        <div class="section-toggle" id="fiberToggle">â–¼</div>
                    </div>
                    <div class="section-content" id="fiberContent">
                        <div class="fiber-categories" id="fiberCategories">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                        <div class="fiber-details" id="fiberDetails">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹è¨˜éŒ²è©³ç´° -->
                        </div>
                        <div class="fiber-summary" id="fiberSummary">
                            <div>ä»Šæ—¥ã®é£Ÿç‰©ç¹Šç¶­: <span id="fiberTotal">0</span>g / <span id="fiberGoal">18</span>g</div>
                            <div class="fiber-progress">
                                <div class="fiber-progress-bar" id="fiberProgressBar" style="width: 0%"></div>
                            </div>
                            <small>ç›®æ¨™é”æˆã¾ã§ <span id="fiberRemaining">18</span>g</small>
                        </div>
                    </div>
                </div>

                <!-- é£Ÿå“å¤šæ§˜æ€§è¨˜éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="section-card">
                    <div class="section-header" onclick="toggleSection('plants')">
                        <div class="section-title">é£Ÿå“å¤šæ§˜æ€§è¨˜éŒ²</div>
                        <div class="section-toggle" id="plantsToggle">â–¼</div>
                    </div>
                    <div class="section-content" id="plantsContent">
                        <div class="plant-input-container">
                            <input type="text" class="plant-input" id="plantInput" placeholder="æ¤ç‰©åã‚’å…¥åŠ›ï¼ˆä¾‹: ãƒˆãƒãƒˆï¼‰">
                            <button class="add-plant-btn" onclick="addPlant()">è¿½åŠ </button>
                        </div>
                        <div class="plants-list" id="plantsList">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                        <div class="weekly-plants-list" id="weeklyPlantsList">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ä»Šé€±ã®æ¤ç‰©ä¸€è¦§ -->
                        </div>
                        <div class="diversity-progress">
                            <div>ä»Šé€±ã®æ¤ç‰©ç¨®é¡: <span id="weeklyPlantCount">0</span> / 30ç¨®é¡</div>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" id="weeklyPlantProgress" style="width: 0%"></div>
                            </div>
                            <small>ç›®æ¨™: é€±30ç¨®é¡</small>
                        </div>
                    </div>
                </div>
            `;
        }

        // é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
        function getWeeklyReport() {
            return `
                <div class="report-section">
                    <div class="report-title">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</div>
                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="weeklyFermentedAvg">0</div>
                            <div class="stat-label">ç™ºé…µé£Ÿå“å¹³å‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="weeklyFiberAvg">0g</div>
                            <div class="stat-label">é£Ÿç‰©ç¹Šç¶­å¹³å‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="weeklyPlantTotal">0</div>
                            <div class="stat-label">æ¤ç‰©ç¨®é¡åˆè¨ˆ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="weeklyRecordRate">0%</div>
                            <div class="stat-label">è¨˜éŒ²ç‡</div>
                        </div>
                    </div>
                </div>
            `;
        }


        // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
        function getMonthlyReport() {
            return `
                <div class="report-section">
                    <div class="report-title">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</div>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="monthlyFermentedAvg">0</div>
                            <div class="stat-label">ç™ºé…µé£Ÿå“å¹³å‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="monthlyFiberAvg">0g</div>
                            <div class="stat-label">é£Ÿç‰©ç¹Šç¶­å¹³å‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="monthlyPlantTotal">0</div>
                            <div class="stat-label">æ¤ç‰©ç¨®é¡åˆè¨ˆ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="monthlyRecordRate">0%</div>
                            <div class="stat-label">è¨˜éŒ²ç‡</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        function loadWeeklyReport() {
            const weekData = getWeeklyData();
            updateWeeklyStats(weekData);
            createWeeklyChart(weekData);
        }

        // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        function loadMonthlyReport() {
            const monthData = getMonthlyData();
            updateMonthlyStats(monthData);
            createMonthlyChart(monthData);
        }


        // é€±æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—
        function getWeeklyData() {
            const today = new Date(currentDate);
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            
            const weekData = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                const dateKey = getDateKey(date);
                const dayData = appData[dateKey] || { fermented: [], fiber: 0, plants: [] };
                weekData.push({
                    date: date,
                    dateStr: date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }),
                    fermented: dayData.fermented.length,
                    fiber: dayData.fiber,
                    plants: dayData.plants.length
                });
            }
            
            return weekData;
        }

        // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—
        function getMonthlyData() {
            const today = new Date(currentDate);
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            const monthData = [];
            for (let i = 0; i < lastDay.getDate(); i++) {
                const date = new Date(firstDay);
                date.setDate(firstDay.getDate() + i);
                const dateKey = getDateKey(date);
                const dayData = appData[dateKey] || { fermented: [], fiber: 0, plants: [] };
                monthData.push({
                    date: date,
                    dateStr: (i + 1).toString(),
                    fermented: dayData.fermented.length,
                    fiber: dayData.fiber,
                    plants: dayData.plants.length
                });
            }
            
            return monthData;
        }

        // é€±æ¬¡çµ±è¨ˆæ›´æ–°
        function updateWeeklyStats(weekData) {
            const fermentedTotal = weekData.reduce((sum, day) => sum + day.fermented, 0);
            const fiberTotal = weekData.reduce((sum, day) => sum + day.fiber, 0);
            const plantTotal = weekData.reduce((sum, day) => sum + day.plants, 0);
            const recordDays = weekData.filter(day => day.fermented > 0 || day.fiber > 0 || day.plants > 0).length;
            
            document.getElementById('weeklyFermentedAvg').textContent = (fermentedTotal / 7).toFixed(1);
            document.getElementById('weeklyFiberAvg').textContent = (fiberTotal / 7).toFixed(1) + 'g';
            document.getElementById('weeklyPlantTotal').textContent = plantTotal;
            document.getElementById('weeklyRecordRate').textContent = Math.round((recordDays / 7) * 100) + '%';
        }

        // æœˆæ¬¡çµ±è¨ˆæ›´æ–°
        function updateMonthlyStats(monthData) {
            const fermentedTotal = monthData.reduce((sum, day) => sum + day.fermented, 0);
            const fiberTotal = monthData.reduce((sum, day) => sum + day.fiber, 0);
            const plantTotal = monthData.reduce((sum, day) => sum + day.plants, 0);
            const recordDays = monthData.filter(day => day.fermented > 0 || day.fiber > 0 || day.plants > 0).length;
            const totalDays = monthData.length;
            
            document.getElementById('monthlyFermentedAvg').textContent = (fermentedTotal / totalDays).toFixed(1);
            document.getElementById('monthlyFiberAvg').textContent = (fiberTotal / totalDays).toFixed(1) + 'g';
            document.getElementById('monthlyPlantTotal').textContent = plantTotal;
            document.getElementById('monthlyRecordRate').textContent = Math.round((recordDays / totalDays) * 100) + '%';
        }

        // é€±æ¬¡ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createWeeklyChart(weekData) {
            const canvas = document.getElementById('weeklyChart');
            if (!canvas) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
            if (window.weeklyChartInstance) {
                window.weeklyChartInstance.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            window.weeklyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weekData.map(day => day.dateStr),
                    datasets: [
                        {
                            label: 'ç™ºé…µé£Ÿå“',
                            data: weekData.map(day => day.fermented),
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'é£Ÿç‰©ç¹Šç¶­(g)',
                            data: weekData.map(day => day.fiber),
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'æ¤ç‰©ç¨®é¡',
                            data: weekData.map(day => day.plants),
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createMonthlyChart(monthData) {
            const canvas = document.getElementById('monthlyChart');
            if (!canvas) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
            if (window.monthlyChartInstance) {
                window.monthlyChartInstance.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            window.monthlyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthData.map(day => day.dateStr),
                    datasets: [
                        {
                            label: 'ç™ºé…µé£Ÿå“',
                            data: monthData.map(day => day.fermented),
                            backgroundColor: 'rgba(76, 175, 80, 0.6)',
                            borderColor: '#4CAF50',
                            borderWidth: 1
                        },
                        {
                            label: 'é£Ÿç‰©ç¹Šç¶­(g)',
                            data: monthData.map(day => day.fiber),
                            backgroundColor: 'rgba(255, 152, 0, 0.6)',
                            borderColor: '#FF9800',
                            borderWidth: 1
                        },
                        {
                            label: 'æ¤ç‰©ç¨®é¡',
                            data: monthData.map(day => day.plants),
                            backgroundColor: 'rgba(33, 150, 243, 0.6)',
                            borderColor: '#2196F3',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(message, type = 'info') {
            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `success-message ${type}`;
            messageDiv.textContent = message;
            
            if (type === 'error') {
                messageDiv.style.background = '#f8d7da';
                messageDiv.style.color = '#721c24';
            }
            
            document.querySelector('.main-content').insertBefore(messageDiv, document.querySelector('.main-content').firstChild);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }




        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«è¡¨ç¤º
        function showTutorial() {
            if (!localStorage.getItem('pmcAppTutorialShown')) {
                const tutorial = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; margin: 20px;">
                            <h2 style="margin-bottom: 20px; color: #333;">ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹</h2>
                            <div style="text-align: left; line-height: 1.6;">
                                <p><strong>1. ç™ºé…µé£Ÿå“è¨˜éŒ²</strong><br>
                                ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é£Ÿã¹ãŸç™ºé…µé£Ÿå“ã‚’é¸æŠ</p>
                                <p><strong>2. é£Ÿç‰©ç¹Šç¶­è¨˜éŒ²</strong><br>
                                ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é£Ÿç‰©ç¹Šç¶­ã‚’è¿½åŠ </p>
                                <p><strong>3. é£Ÿå“å¤šæ§˜æ€§è¨˜éŒ²</strong><br>
                                æ¤ç‰©åã‚’å…¥åŠ›ã—ã¦é€±30ç¨®é¡ã‚’ç›®æŒ‡ã™</p>
                                <p><strong>4. ãƒ¬ãƒãƒ¼ãƒˆ</strong><br>
                                é€±æ¬¡ãƒ»æœˆæ¬¡ã®é€²æ—ã‚’ã‚°ãƒ©ãƒ•ã§ç¢ºèª</p>
                            </div>
                            <button onclick="closeTutorial()" style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 8px; margin-top: 20px; cursor: pointer; width: 100%;">
                                å§‹ã‚ã‚‹
                            </button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', tutorial);
            }
        }

        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é–‰ã˜ã‚‹
        function closeTutorial() {
            const tutorial = document.querySelector('[style*="z-index: 2000"]');
            if (tutorial) {
                tutorial.remove();
                localStorage.setItem('pmcAppTutorialShown', 'true');
            }
        }

        // é€£ç¶šè¨˜éŒ²æ—¥æ•°è¨ˆç®—
        function calculateStreak() {
            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < 365; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateKey = getDateKey(date);
                const dayData = appData[dateKey];
                
                if (dayData && (dayData.fermented.length > 0 || dayData.fiber > 0 || dayData.plants.length > 0)) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // é”æˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        function checkAchievements() {
            const dateKey = getDateKey(currentDate);
            const dayData = appData[dateKey] || { fermented: [], fiber: 0, plants: [] };
            
            // ç™ºé…µé£Ÿå“ç›®æ¨™é”æˆ
            if (dayData.fermented.length >= 2) {
                showMessage('ğŸ‰ ç™ºé…µé£Ÿå“ç›®æ¨™é”æˆï¼ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼', 'success');
            }
            
            // é£Ÿç‰©ç¹Šç¶­ç›®æ¨™é”æˆ
            if (dayData.fiber >= settings.fiberGoal) {
                showMessage('ğŸ‰ é£Ÿç‰©ç¹Šç¶­ç›®æ¨™é”æˆï¼å¥åº·çš„ã§ã™ã­ï¼', 'success');
            }
            
            // é€±æ¬¡æ¤ç‰©ç›®æ¨™é”æˆ
            const weekPlants = getWeeklyPlants();
            const uniquePlants = [...new Set(weekPlants)];
            if (uniquePlants.length >= 30) {
                showMessage('ğŸ‰ é€±æ¬¡æ¤ç‰©å¤šæ§˜æ€§ç›®æ¨™é”æˆï¼ç´ æ™´ã‚‰ã—ã„å¤šæ§˜æ€§ã§ã™ï¼', 'success');
            }
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼šãƒ‡ãƒ¼ã‚¿ã®å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        function cleanupOldData() {
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            
            Object.keys(appData).forEach(dateKey => {
                const date = new Date(dateKey);
                if (date < oneMonthAgo) {
                    delete appData[dateKey];
                }
            });
            
            saveData();
        }

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
        window.addEventListener('error', function(e) {
            console.error('ã‚¢ãƒ—ãƒªã‚¨ãƒ©ãƒ¼:', e.error);
            showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
        });

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
        window.addEventListener('online', function() {
            showMessage('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸ', 'success');
        });

        window.addEventListener('offline', function() {
            showMessage('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚', 'error');
        });

        // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
        function resetAllData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                // LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                localStorage.removeItem('pmcAppData');
                localStorage.removeItem('pmcAppSettings');
                localStorage.removeItem('pmcAppTutorialShown');
                localStorage.removeItem('pmcAppLastCleanup');
                
                // ã‚¢ãƒ—ãƒªãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
                appData = {};
                settings = {
                    gender: 'female',
                    fiberGoal: 18,
                    notifications: true
                };
                
                // ã‚¢ãƒ—ãƒªã‚’å†åˆæœŸåŒ–
                initializeApp();
                showMessage('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
                
                // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                showPage('main');
            }
        }

        // åˆæœŸåŒ–å®Œäº†
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadSettings();
            initializeApp();
            setupEventListeners();
            showTutorial();
            
            // æœˆ1å›ã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            const lastCleanup = localStorage.getItem('pmcAppLastCleanup');
            const now = new Date();
            if (!lastCleanup || (now - new Date(lastCleanup)) > 30 * 24 * 60 * 60 * 1000) {
                cleanupOldData();
                localStorage.setItem('pmcAppLastCleanup', now.toISOString());
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆç”¨ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆé–‹ç™ºç”¨ï¼‰
            // Ctrl+Shift+R ã§ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                    e.preventDefault();
                    resetAllData();
                }
            });
        });
    </script>
</body>
</html>
